<!DOCTYPE html>
<html style="font-size: 16px;" lang="en"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <title>Profile Domain Timing</title>
    <link rel="stylesheet" href="nicepage.css" media="screen">
<link rel="stylesheet" href="Profile-Domain-Timing.css" media="screen">
    <script class="u-script" type="text/javascript" src="jquery.js" defer=""></script>
    <script class="u-script" type="text/javascript" src="nicepage.js" defer=""></script>
    <meta name="generator" content="Nicepage 7.0.3, nicepage.com">
    <link id="u-theme-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i|Gayathri:100,400,700">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="application/ld+json">{
		"@context": "http://schema.org",
		"@type": "Organization",
		"name": "personal page",
		"logo": "images/meblue.png"
}</script>
    <meta name="theme-color" content="#d1308c">
    <meta property="og:title" content="Profile Domain Timing">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
  <meta data-intl-tel-input-cdn-path="intlTelInput/"></head>
  <body data-path-to-root="./" data-include-products="false" class="u-body u-xl-mode" data-lang="en"><header class="u-black u-clearfix u-header u-sticky u-sticky-cf4a" id="sec-9946" data-animation-name="" data-animation-duration="0" data-animation-delay="0" data-animation-direction=""><div class="u-clearfix u-sheet u-sheet-1">
        <a href="./" class="u-align-right u-image u-logo u-image-1" data-image-width="837" data-image-height="838" title="Rowina">
          <img src="images/meblue.png" class="u-logo-image u-logo-image-1">
        </a>
        <nav class="u-align-center u-menu u-menu-dropdown u-offcanvas u-menu-1">
          <div class="menu-collapse" style="font-size: 1rem; letter-spacing: 0px;">
            <a class="u-button-style u-custom-left-right-menu-spacing u-custom-padding-bottom u-custom-top-bottom-menu-spacing u-hamburger-link u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="#">
              <svg class="u-svg-link" viewBox="0 0 24 24"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#menu-hamburger"></use></svg>
              <svg class="u-svg-content" version="1.1" id="menu-hamburger" viewBox="0 0 16 16" x="0px" y="0px" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"><g><rect y="1" width="16" height="2"></rect><rect y="7" width="16" height="2"></rect><rect y="13" width="16" height="2"></rect>
</g></svg>
            </a>
          </div>
          <div class="u-custom-menu u-nav-container">
            <ul class="u-nav u-unstyled u-nav-1"><li class="u-nav-item"><a class="u-button-style u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="./#sec-03ce" style="padding: 10px 20px;">Home</a>
</li><li class="u-nav-item"><a class="u-button-style u-file-link u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="files/RowinaNathanCV1.pdf" target="_blank" style="padding: 10px 20px;">Resume</a><div class="u-nav-popup"><ul class="u-h-spacing-20 u-nav u-unstyled u-v-spacing-10"><li class="u-nav-item"><a class="u-black u-button-style u-file-link u-nav-link u-text-hover-palette-2-base" href="files/RowinaNathan-Academic.pdf" target="_blank">Academic Resume</a>
</li><li class="u-nav-item"><a class="u-black u-button-style u-file-link u-nav-link u-text-hover-palette-2-base" href="files/RowinaNathan-Industry.pdf" target="_blank">Industry Resume</a>
</li></ul>
</div>
</li><li class="u-nav-item"><a class="u-button-style u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="./#sec-201b" style="padding: 10px 20px;">Publications</a>
</li><li class="u-nav-item"><a class="u-button-style u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="./#sec-d554" style="padding: 10px 20px;">Contact</a>
</li></ul>
          </div>
          <div class="u-custom-menu u-nav-container-collapse">
            <div class="u-black u-container-style u-inner-container-layout u-opacity u-opacity-95 u-sidenav">
              <div class="u-inner-container-layout u-sidenav-overflow">
                <div class="u-menu-close"></div>
                <ul class="u-align-center u-nav u-popupmenu-items u-unstyled u-nav-3"><li class="u-nav-item"><a class="u-button-style u-nav-link" href="./#sec-03ce">Home</a>
</li><li class="u-nav-item"><a class="u-button-style u-file-link u-nav-link" href="files/RowinaNathanCV1.pdf" target="_blank">Resume</a><div class="u-nav-popup"><ul class="u-h-spacing-20 u-nav u-unstyled u-v-spacing-10"><li class="u-nav-item"><a class="u-button-style u-file-link u-nav-link" href="files/RowinaNathan-Academic.pdf" target="_blank">Academic Resume</a>
</li><li class="u-nav-item"><a class="u-button-style u-file-link u-nav-link" href="files/RowinaNathan-Industry.pdf" target="_blank">Industry Resume</a>
</li></ul>
</div>
</li><li class="u-nav-item"><a class="u-button-style u-nav-link" href="./#sec-201b">Publications</a>
</li><li class="u-nav-item"><a class="u-button-style u-nav-link" href="./#sec-d554">Contact</a>
</li></ul>
              </div>
            </div>
            <div class="u-black u-menu-overlay u-opacity u-opacity-70"></div>
          </div>
        </nav>
        <img class="u-hidden-xs u-image u-image-contain u-image-default u-image-2" src="images/monashlogo_white.png" alt="" data-image-width="2718" data-image-height="788">
        <img class="u-hidden-md u-hidden-sm u-hidden-xs u-image u-image-contain u-image-default u-image-3" src="images/Gradient-Logo-White-with-Text-600x249.jpg" alt="" data-image-width="600" data-image-height="249" data-href="https://www.ozgrav.org" data-target="_blank">
      </div></header>
    <section class="u-black u-clearfix u-section-1" id="sec-062f">
      <div class="u-clearfix u-sheet u-valign-middle u-sheet-1">
        <img class="u-expanded-width u-image u-preserve-proportions u-image-1" src="images/header_IPTA.png" data-image-width="2138" data-image-height="503">
      </div>
    </section>
    <section class="u-black u-clearfix u-section-2" id="sec-91c4">
      <div class="u-clearfix u-sheet u-sheet-1">
        <p class="u-text u-text-1"> Most pulsar timing methods use a template to fit pulse time of arrivals (TOAs). In this tutorial we will create dynamic, flexible, independent fits for the Pulsar J1103-5403 to find TOAs. This tutorial follows the method used in <a href="https://arxiv.org/abs/2304.02793" class="u-active-none u-border-none u-btn u-button-link u-button-style u-hover-none u-none u-text-palette-4-base u-btn-1" target="_blank">Nathan et al. (2023)</a>&nbsp;to time J1103-5403 and then use shape information to create a more accurate, filtered timing solution.&nbsp;<br>
          <br>For this tutorial you will need the accompanying python script <a href="https://github.com/rowina-n" class="u-active-none u-border-none u-btn u-button-link u-button-style u-hover-none u-none u-text-palette-4-base u-btn-2" target="_blank">dynamic_fitting.py</a>.&nbsp;<br>
          <br>Throughout this tutorial when I say pulses I really mean epochs (as the observations are folded in time).<br>
        </p>
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h2 style="color: #BF3F88;">Contents</h2>
          <ul>
            <li>
              <a href="#1--load-in-an-archive-file">1. Load in an archive file</a>
              <ul>
                <li>
                  <a href="#plot-the-pulse">Plot the pulse</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#2-fit-a-curve-to-the-data">2. Fit a curve to the data</a>
            </li>
            <li>
              <a href="#3-determining-the-toa-from-a-kookaburra-fit">3. Determining the TOA from a Kookaburra fit</a>
            </li>
            <li>
              <a href="#4-creating-toas-for-a-series-of-pulses">4. Creating TOAs for a series of pulses</a>
              <ul>
                <li>
                  <a href="#step-1">Step 1</a>
                </li>
                <li>
                  <a href="#step-2">Step 2</a>
                </li>
                <li>
                  <a href="#step-3">Step 3</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#5-generating-a-timing-solution">5. Generating a timing solution</a>
            </li>
            <li>
              <a href="#6-pulse-shape-information">6. Pulse shape information</a>
            </li>
            <li>
              <a href="#7-using-pulse-shape-information-to-improve-a-pulsar-timing-solution">7. Using pulse shape information to improve a pulsar timing solution</a>
            </li>
            <li>
              <a href="#wrap-up">Wrap up</a>
            </li>
            <li>
              <a href="#notes">Notes</a>
              <ul>
                <li>
                  <a href="#code-to-convert-all-archive-files-to-text-files">Code to convert all archive files to text files</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </section>
    <section class="u-black u-clearfix u-section-3" id="sec-8ad9">
      <div class="u-clearfix u-sheet u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h1 style="color: #BF3f88;">Prerequisites</h1>
          <p>In order to complete this tutorial you will need a terminal environment set up with <code style="color: #ffa1d6;">psrchive</code>, <code style="color: #ffa1d6;">libstempo</code> and <code style="color: #ffa1d6;">tempo2</code>. You will also need the python packages <code style="color: #ffa1d6;">numpy</code>, <code style="color: #ffa1d6;">pandas</code> and <code style="color: #ffa1d6;">matplotlib</code>.
          </p>
          <p>You should be able to run:</p>
          <pre style="color: #ffa1d6;">            <code class="language-python"> import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import os
import json
import psrchive as ps
import libstempo as T </code>
          </pre>
          <br>
          <p>Lastly, you should install <code style="color: #ffa1d6;">Kookaburra</code> by running:
          </p>
          <pre style="color: #ffa1d6;">            <code class="language-bash"> pip install kookaburra </code>
          </pre>
          <p>Kookaburra is a package used for fitting radio-pulsar flux. The documentation for Kookaburra can be found <a href="https://kookaburra.readthedocs.io/en/latest/">here</a>.
          </p>
        </div>
      </div>
    </section>
    <section class="u-black u-clearfix u-section-4" id="sec-7fc0">
      <div class="u-clearfix u-sheet u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h1 style="color: #BF3f88;">1. Load in an archive file</h1>
          <p>In order to fit the pulse, we must first turn the archive file into python-readable flux data. In this tutorial, we will fully integrate frequency, polarization, and time sub-intervals. In the python script, you will see a function <code style="color: #ffa1d6;">fits_to_txt()</code> that integrates the data and returns a dataframe with the time, frequency, and pulse number.
          </p>
          <p>I learnt on Monday that you could totally do this using PSRCHIVE tools such as pdv or psrsh, but this works too.</p>
          <p>In this tutorial, we will be using archive files from the MeerKAT radio telescope.</p>
          <p>To then use this function we can do the following:</p>
          <pre style="color: #ffa1d6;">            <code class="language-python"> # Path to archive file
filename = 'data/J1103-5403_2019-08-02-16:29:52_zap.dly_p_turn'
# Set pulse number (normally I loop through all archive files changing the pulse number each time)
i = 0
# Make empty dataframe for flux data
pulse_data = pd.DataFrame(columns=["time", "flux", "pulse_number"])
# Make empty dataframe to keep track of the file corresponding to each pulse
pulse_names = pd.DataFrame(columns=["filename", "pulse_number"])
# Call fits_to_txt
pulse_data_single = fits_to_txt(filename, i)
# Keep track of file names
pulse_names_single = pd.DataFrame(dict(filename=[str(filename)], pulse_number=[i]))
# Concatenate data frames
pulse_data = pd.concat([pulse_data, pulse_data_single])
pulse_names = pd.concat([pulse_names, pulse_names_single]) </code>
          </pre>
          <p>Copy this into the python script and run it. Print the <code style="color: #ffa1d6;">pulse_data</code> to ensure it has worked.
          </p>
          <p>The way that this is coded with the concatenations may seem a bit tedious, but it makes it easy to convert this code into a loop that goes over all archive files.</p>
          <p>You should make a directory to keep your results in, run this in the <strong>terminal</strong>:
          </p>
          <pre style="color: #ffa1d6;">            <code class="language-bash"> mkdir results </code>
          </pre>
          <p>Then save the integrated pulses to a text file:</p>
          <pre style="color: #ffa1d6;">            <code class="language-python"> pulse_names.to_csv('results/pulses_name.txt', index=False)
pulse_data.to_csv('results/pulses.txt', index=False) </code>
          </pre>
          <h3>Plot the pulse</h3>
          <p>It is also important to plot the data to ensure it looks as we would expect.</p>
          <pre style="color: #ffa1d6;">            <code class="language-python"> plot_single('results/pulses.txt')
plt.clf() </code>
          </pre>
          <p>Copy this into your python script and check the data looks reasonable.</p>
        </div>
      </div>
    </section>
    <section class="u-black u-clearfix u-section-5" id="sec-2dce">
      <div class="u-clearfix u-sheet u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h1 style="color: #BF3f88;">2. Fit a curve to the data </h1>
          <p>Kookaburra works using the command line. To see how it works (and to check that you have installed it) run:</p>
          <pre style="color: #ffa1d6;">            <code class="language-bash"> kb_single_pulse --help </code>
          </pre>
          <p>Have a look at all the possible options.</p>
          <p>To begin with, let’s fit a single Gaussian to our pulse.</p>
          <p>Copy this into the terminal:</p>
          <pre style="color: #ffa1d6;">            <code class="language-bash"> kb_single_pulse results/pulses.txt --time-unit ms -p 0 -s 1 -b 2 --nlive 100 --plot-fit --plot-corner --outdir results </code>
          </pre>
          <p>This calls the <code style="color: #ffa1d6;">kb_single_pulse</code> function on our text file:
          </p>
          <ul>
            <li>
              <code style="color: #ffa1d6;">--time-unit</code> Set the time unit to ms
            </li>
            <li>
              <code style="color: #ffa1d6;">-p</code> Choose pulse 0.
            </li>
            <li>
              <code style="color: #ffa1d6;">-s</code> Fit a singular Gaussian (1 component shapelet, we don't have time to go into shapelets today, see <a href="https://en.wikipedia.org/wiki/Hermite_polynomials#Hermite_functions">Hermite-Gaussian Functions</a> for a description).
            </li>
            <li>
              <code style="color: #ffa1d6;">-b</code> Choose a 2-component polynomial function to model the baseline flux (there should be none since we removed it in step 1).
            </li>
            <li>
              <code style="color: #ffa1d6;">--nlive</code> Choose 100 live points, normally I would use more, but I am trying to save your computer.
            </li>
            <li>
              <code style="color: #ffa1d6;">--plot-fit</code> We want to see a plot of the fit to the data.
            </li>
            <li>
              <code style="color: #ffa1d6;">--plot-corner</code> We also want to see a corner plot.
            </li>
            <li>
              <code style="color: #ffa1d6;">--outdir</code> Save the fit and plots to the results directory.
            </li>
          </ul>
          <p>The results directory should now have a <code style="color: #ffa1d6;">.json</code> file with the fit results and some plots. As you may have guessed, a single Gaussian is not a good fit for this pulse.
          </p>
          <p>Let’s try a more complex fit, perhaps 3 Gaussians.</p>
          <pre style="color: #ffa1d6;">            <code class="language-bash"> kb_single_pulse results/pulses.txt --time-unit ms -p 0 -s 1 1 1 -b 2 --nlive 100 --plot-fit --plot-corner --outdir results </code>
          </pre>
          <p>Now experiment with the settings seen in <code style="color: #ffa1d6;">kb_single_pulse --help</code> to get the best fit.
          </p>
          <p>In the paper I used:</p>
          <pre style="color: #ffa1d6;">            <code class="language-bash"> kb_single_pulse results/pulses.txt --time-unit ms -p 0 -s 1 1 1 -b 2 --nlive 1000 --c-max-multiplier 2 --c-mix 0 --beta-min 0.0165 --beta-max 0.2 --beta-type log-uniform --plot-fit --plot-corner --outdir results </code>
          </pre>
          <p>See if this fit works for you.</p>
          <p>
            <strong>Note:</strong> This set of hyperparameters was determined using trial and error. I currently have a student working on profile domain timing with <code style="color: #ffa1d6;">tBilby</code>, a new trans-dimensional sampling arm of <code style="color: #ffa1d6;">Bilby</code> (Bayesian Inference Library) developed at Monash. This allows the data to determine the number of functions required to best fit the data, rather than trial and error. Keep your eye out for a paper.
          </p>
        </div>
      </div>
    </section>
    <section class="u-black u-clearfix u-section-6" id="sec-fbed">
      <div class="u-clearfix u-sheet u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h1 style="color: #BF3f88;">3. Determining the TOA from a Kookaburra fit</h1>
          <p>Now that we have fit a curve to our data, we must determine a time of arrival (TOA) in order to produce a timing solution.</p>
          <p>Back to Python.</p>
          <p>In the provided Python script, there is a function called <code style="color: #ffa1d6;">kook_to_tim</code> that takes the <code style="color: #ffa1d6;">.json</code> file output by Kookaburra and turns it into a <code style="color: #ffa1d6;">.tim</code> file. It is designed so that you can input a list of <code style="color: #ffa1d6;">.json</code> files and it will combine them into a single timing file.
          </p>
          <p>Inside <code style="color: #ffa1d6;">kook_to_tim</code>, a feature is chosen from the fit to measure the TOA. In this tutorial and in my paper, we use the mean of the third Gaussian (which is always the highest flux). This can easily be customized by altering the <code style="color: #ffa1d6;">kook_to_tim</code> function and choosing a different value (or values; you can get creative) from the <code style="color: #ffa1d6;">.json</code> fit file.
          </p>
          <p>Add this into your Python script to call the function:</p>
          <pre style="color: #ffa1d6;">            <code class="language-python"> kook_to_tim(1, fit_directory='results', outdir='results') </code>
          </pre>
          <p>Your <code style="color: #ffa1d6;">.tim</code> file should look like this:
          </p>
          <pre style="color: #ffa1d6;">            <code> FORMAT 1
data/J1103-5403_2019-08-02-16:29:52_zap.dly_p_turn 1286.4481343752045 58697.689028154301923 0.627104040943004426 meerkat </code>
          </pre>
          <p>So you've now found a TOA for this first pulse of 58697.68902813563431 MJD.</p>
        </div>
      </div>
    </section>
    <section class="u-black u-clearfix u-section-7" id="sec-fa26">
      <div class="u-clearfix u-sheet u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h1 style="color: #BF3f88;">4. Creating TOAs for a series of pulses</h1>
          <p>We have found a single TOA, but we require a series of TOAs to make a timing solution. To do this, we repeat steps 1, 2, and 3, but loop over epochs at each step to produce a TOA for each epoch.</p>
          <h2>Step 1</h2>
          <p>I will provide the <code style="color: #ffa1d6;">pulses_all.txt</code> file for 52 epochs, as downloading and processing 52 epochs would be unnecessarily time-consuming. See note 1 for the code to do this yourself.
          </p>
          <h2>Step 2</h2>
          <p>It is easy to make a bash script to launch the fit for all 52 pulses, especially if you have access to a computing cluster and are able to run them in parallel.</p>
          <p>To run all fits on your local machine in series, copy and paste this into a bash script <code style="color: #ffa1d6;">launch.sh</code>:
          </p>
          <pre style="color: #ffa1d6;">            <code class="language-bash"> #!/bin/bash
mkdir results/fits
for i in {0..51}
do
    kb_single_pulse pulses_all.txt --time-unit ms -p $i -s 1 1 1 -b 2 --nlive 100 --plot-fit --plot-corner --outdir results/fits
done </code>
          </pre>
          <p>If you have access to a cluster, I would strongly recommend launching these jobs in parallel. I do this using a series of two bash scripts:</p>
          <p>
            <code style="color: #ffa1d6;">launch.sh</code>:
          </p>
          <pre style="color: #ffa1d6;">            <code class="language-bash"> #!/bin/bash
#SBATCH stuff here or whatever queue management commands your supercomputer uses
#load in environment with kookaburra
kb_single_pulse pulses_all.txt --time-unit ms -p ${1} -s 1 1 1 -b 2 --nlive 100 --plot-fit --plot-corner --outdir results/fits </code>
          </pre>
          <p>and then <code style="color: #ffa1d6;">launch_n.sh</code> (you should probably give these scripts more informative names):
          </p>
          <pre style="color: #ffa1d6;">            <code class="language-bash"> #!/bin/bash
mkdir results/fits
for i in {0..51}
do
    sbatch launch.sh $i
done </code>
          </pre>
          <p>
            <code style="color: #ffa1d6;">sbatch</code> is the command to submit jobs to the queue on the computer I use.
          </p>
          <p>These things are time-consuming and will not run in the time we have, so I suggest using the fits provided in <code style="color: #ffa1d6;">results/fits/</code> and generating fits in your own time.
          </p>
          <h2>Step 3</h2>
          <p>Provide all fits to <code style="color: #ffa1d6;">kook_to_tim</code>. In your code, it will look like this:
          </p>
          <pre style="color: #ffa1d6;">            <code class="language-python"> kook_to_tim(52, fit_directory='results/fits', outdir='results') </code>
          </pre>
          <p>I have provided a timing file in case you have any trouble with this.</p>
          <p>After running this, you should have a <code style="color: #ffa1d6;">.tim</code> file with TOAs for 52 pulses. I have again provided the <code style="color: #ffa1d6;">.tim</code> file that I generated if this step doesn't work for you or we run out of time in <code style="color: #ffa1d6;">results/J1103.tim</code>.
          </p>
        </div>
      </div>
    </section>
    <section class="u-black u-clearfix u-section-8" id="sec-b655">
      <div class="u-clearfix u-sheet u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h1>5. Generating a timing solution</h1>
          <p>Hopefully you now know how to generate a timing solution after the <code style="color: #ffa1d6;">TEMPO2</code> tutorial. You now want to generate a timing solution using your <code style="color: #ffa1d6;">.tim</code> file and the provided <code style="color: #ffa1d6;">.par</code> file.
          </p>
          <p>I usually use a command like this in the <strong>terminal</strong>:
          </p>
          <pre style="color: #ffa1d6;">            <code class="language-bash"> tempo2 -gr plk -f results/new.par results/J1103.tim </code>
          </pre>
          <p>Your timing solution should look something like the teal points in the plot!</p>
          <p>This should provide you with a timing solution that is marginally better than one produced with template-fit TOAs.</p>
          <p>It is already apparent that this pulsar may be exhibiting mode-changing behaviour. In the next section, we are going to use the pulse shape information itself to investigate this and further improve the timing solution.</p>
        </div>
        <img class="u-image u-image-contain u-image-default u-image-1" src="images/ts_kook_psr.png" alt="" data-image-width="970" data-image-height="600">
      </div>
    </section>
    <section class="u-black u-clearfix u-section-9" id="sec-38f2">
      <div class="u-clearfix u-sheet u-valign-middle u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h1>6. Pulse shape information</h1>
          <p>To investigate our mode changing hypothesis, let's plot the shape of the two groups of pulses. I divided them by looking at pulses that have a residual less than or greater than <code style="color: #ffa1d6;">2.5μs</code>.
          </p>
        </div>
        <img class="u-image u-image-contain u-image-default u-image-1" src="images/ts_kook_psr_line.png" alt="" data-image-width="1000" data-image-height="650">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-2">
          <p>Now let's plot the average shape of the two groups of pulses to look for a difference in pulse shape.</p>
          <pre style="color: #ffa1d6;">            <code class="language-python"> #define directories
T.data =  'data'
directory = 'results'
#load in a timing solution
psr_1 = T.tempopulsar(
    parfile= directory + "/new.par", 
    timfile= directory + "/J1103.tim"
)
#make a list for saving the filenames of Mode B pulses 
filename_lst=[]
#load in pulse names and pulse data
names=pd.read_csv("names_all.txt")
pulses=pd.read_csv("pulses_all.txt")
#save the file names of all Mode B pulses (this condition can be easily changed)
for i in range(52):
    if (psr_1.residuals()[i]*1e6) &gt;= -2.5:
        filename_temp = str(psr_1.filename()[i])
        filename_temp = filename_temp.strip("b'")
        filename_temp = filename_temp.split("/")[-1]
        filename_lst.append(filename_temp)
#print the number of Mode B pulses
print("Number of Mode B pulses: ", len(filename_lst))
#create a numpy array for the average flux data
fluxA = np.zeros(1024)
fluxB = np.zeros(1024)
#sum all pulses in Mode B and Mode A
for i in range(names.shape[0]):
    name = names['filename'][i]
    pulse_number = names[names['filename'] == name]["pulse_number"].iloc[0]
    print(pulse_number)
    if name in filename_lst:
        flux_tempB = np.array(pulses[pulses['pulse_number'] == pulse_number]['flux'])
        fluxB = fluxB + flux_tempB
    else:
        flux_tempA = np.array(pulses[pulses['pulse_number'] == pulse_number]['flux'])
        fluxA = fluxA + flux_tempA
#Save normalised average pulse profiles
np.savetxt("results/ModeB_avg.txt", fluxB / np.max(fluxB))
np.savetxt("results/ModeA_avg.txt", fluxA / np.max(fluxA)) </code>
          </pre>
          <p>Then plot these two average pulses to compare!</p>
          <pre style="color: #ffa1d6;">            <code class="language-python"> #read in data
modeA = pd.read_csv("results/ModeA_avg.txt")
modeB = pd.read_csv("results/ModeB_avg.txt")
#create a numpy array for phase 
phase = np.linspace(0, 1, 1023)
phase = np.reshape(phase, (1023, 1))
#plot both curves
plt.plot(phase, modeA / np.max(modeA), label=r"greater than $-2.5 \mu s$")
plt.plot(phase, modeB / np.max(modeB), label=r"less than $-2.5 \mu s$")
plt.xlabel("Phase (revolutions)")
plt.ylabel("Normalised Flux")
plt.tight_layout()
plt.legend(title="Timing Solution Residual")
plt.xlim(0, 1)
plt.savefig("results/mode_profile.png")
plt.close() </code>
          </pre>
          <p>Your plot should look something like this.</p>
        </div>
      </div>
    </section>
    <section class="u-black u-clearfix u-container-align-center u-section-10" id="sec-d291">
      <div class="u-clearfix u-sheet u-valign-middle u-sheet-1">
        <img class="u-image u-image-contain u-image-default u-image-1" src="images/mode_profile.png" alt="" data-image-width="970" data-image-height="600">
        <div class="u-clearfix u-custom-html u-custom-html-1">
          <p>You can see that the peak flux of the two groups of pulses does not change much, but the pulse leading edge at around 0.42 and the pulse shoulder at around 0.3 have substantial differences. Let's focus on the leading edge of the pulse.</p>
        </div>
      </div>
    </section>
    <section class="u-black u-clearfix u-section-11" id="sec-497c">
      <div class="u-clearfix u-sheet u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h1>7. Using pulse shape information to improve a pulsar timing solution</h1>
          <p>Now that we know that the two groups of pulses on average have different pulse shapes, we can use this to include only one mode in our timing solution. From now on I will call them <strong>Mode A</strong> (residual above 2.5μs) and <strong>Mode B</strong> (residual below 2.5μs). Mode A is teal and Mode B is orange.
          </p>
          <p>If we imagine our 3 Gaussian fit, we can look at the height of the second Gaussian (which is fit to that leading edge) to differentiate the two groups. We have been looking at normalised plots of the flux, where the brightest portion of the pulse is normalised to 1. Therefore it makes sense to compare the ratio of the height of the second Gaussian to the third. As python counts from 0, and the amplitudes are denoted by Cs in <code style="color: #ffa1d6;">Kookaburra</code>, we will be looking at the ratio C_1/C_2.
          </p>
          <p>I have created this plot to investigate the amplitude ratio.</p>
        </div>
        <img class="u-image u-image-contain u-image-default u-preserve-proportions u-image-1" src="images/c1c2_double.png" alt="" data-image-width="1000" data-image-height="1000">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-2">
          <p>We can see from the plot that the amplitude ratio can be used to divide the pulses into two groups. Firstly, the histogram of the amplitude ratios looks slightly bi-modal, and we can use this bi-modality to design a filter to improve our timing solution. We can, for example, cut out all of the pulses with an amplitude ratio C_1/C_2 &gt; 0.21 which is the dotted line on the above plot. This cut keeps a large portion of Mode A pulses while removing all but one Mode B pulses.</p>
          <p>To do this, turn on the <code style="color: #ffa1d6;">filter_mode</code> in the <code style="color: #ffa1d6;">kook_to_tim</code> function. You can see in the function how this filter condition could be easily changed depending on the problem.
          </p>
          <pre>            <code style="color: #ffa1d6;">kook_to_tim(52, fit_directory='results/fits', outdir='results', filter_mode=True)</code>
          </pre>
          <p>Now that you have a filtered <code style="color: #ffa1d6;">.tim</code> file you can create a new timing solution.
          </p>
          <pre>            <code style="color: #ffa1d6;">tempo2 -gr plk -f results/new.par results/J1103_filtered.tim</code>
          </pre>
          <p>You should now have a timing solution with an RMS of only $1.343μs$.</p>
          <p>This dynamically-fitting and filtering the data has reduced the RMS from 2.393μs to 1.343μs. This translates to a factor 4.3 reduction in ECORR (pulse jitter term) meaning the mode changing in this pulsar was misclassified as jitter! This single-mode timing solution increases the sensitivity of this pulsar to the gravitational-wave background signal to noise ratio by 32%. See the paper for details.</p>
        </div>
        <img class="u-image u-image-contain u-image-default u-image-2" src="images/ts_kook_filt.png" alt="" data-image-width="970" data-image-height="600">
      </div>
    </section>
    <section class="u-black u-clearfix u-section-12" id="sec-6e64">
      <div class="u-clearfix u-sheet u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h1>Wrap up</h1>
          <p>Here we have used the fits to each pulse to improve the timing solution using pulse shape information. I can imagine however that there could be many other uses for data about pulse shape similar to what we have produced in this tutorial. <code style="color: #ffa1d6;">Kookaburra</code> is pip installable so I would encourage you to use it for your own research. Please submit a merge request if you find any issues or make any improvements to <code style="color: #ffa1d6;">Kookaburra</code>.
          </p>
          <p>As mentioned earlier we are currently developing the trans-dimensional fitting algorithm for this using <code style="color: #ffa1d6;">tBilby</code>. Full Bayesian fits using <code style="color: #ffa1d6;">Kookaburra</code> can be slow, so depending on the purpose of your pulse fitting, you may wish to use something like <code style="color: #ffa1d6;">minuit</code> for the fitting portion. Now that you can turn pulse fits into <code style="color: #ffa1d6;">.tim</code> files you can really use any fitting algorithm. The possibilities are endless.
          </p>
          <p>I do plan to push the scripts I have demonstrated here (for turning archive files into text files and turning fits into timing files) to <code style="color: #ffa1d6;">Kookaburra</code> at some point.
          </p>
        </div>
      </div>
    </section>
    <section class="u-black u-clearfix u-section-13" id="sec-2f4a">
      <div class="u-clearfix u-sheet u-valign-top u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width u-custom-html-1">
          <h1>Notes</h1>
          <h2>Code to convert all archive files to text files</h2>
          <pre>            <code style="color: #ffa1d6;">#path to archive file
directory = r'data/'
#Make empty dataframe for flux data
pulse_data = pd.DataFrame(columns=["time", "flux", "pulse_number"])
#Make empty data frame to keep track for the file corresponding to each pulse
pulse_names = pd.DataFrame(columns=["filename","pulse_number"])
#make a list of archive files
lst=sorted(glob.glob(directory+r"*.r"))
for i in range(len(lst)):
    filename=lst[i].split("/")[-1]
    print(filename) 
    
    pulse_data_single = fits_to_txt(filename,i)
    pulse_names_single = pd.DataFrame(dict(filename=[str(filename)], pulse_number=[i]))
    pulse_data = pd.concat([pulse_data, pulse_data_single])
    pulse_names = pd.concat([pulse_names, pulse_names_single])
pulse_names.to_csv('results/names_all.txt',index=False)
pulse_data.to_csv('results/pulses_all.txt', index=False) </code>
          </pre>
        </div>
      </div>
    </section>
    
    
    
    <footer class="u-align-center-md u-align-center-sm u-align-center-xs u-clearfix u-footer u-palette-1-base" id="sec-6990"><div class="u-clearfix u-sheet u-valign-middle u-sheet-1">
        <div class="data-layout-selected u-clearfix u-expanded-width u-layout-wrap u-layout-wrap-1">
          <div class="u-layout">
            <div class="u-layout-row">
              <div class="u-container-style u-layout-cell u-size-20 u-layout-cell-1">
                <div class="u-container-layout u-valign-middle u-container-layout-1">
                  <a href="./#sec-03ce" class="u-align-left u-border-2 u-border-hover-palette-2-base u-border-white u-btn u-btn-round u-button-style u-hover-palette-2-base u-none u-radius-33 u-text-hover-palette-1-base u-text-white u-btn-1">home<span class="u-file-icon u-icon u-text-palette-3-base u-icon-1"><img src="images/1946488-720edc7f.png" alt=""></span>
                  </a>
                </div>
              </div>
              <div class="u-container-style u-layout-cell u-size-20 u-layout-cell-2">
                <div class="u-container-layout u-valign-middle u-container-layout-2">
                  <p class="u-align-center u-text u-text-palette-2-base u-text-1">Rowina Nathan</p>
                </div>
              </div>
              <div class="u-container-style u-layout-cell u-size-20 u-layout-cell-3">
                <div class="u-container-layout u-container-layout-3">
                  <img class="u-align-right u-image u-image-contain u-image-default u-image-1" src="images/monashlogo_white.png" alt="" data-image-width="2718" data-image-height="788">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div></footer>
    <section class="u-backlink u-clearfix u-grey-80">
      <p class="u-text">
        <span>This site was created with the </span>
        <a class="u-link" href="https://nicepage.com/" target="_blank" rel="nofollow">
          <span>Nicepage</span>
        </a>
      </p>
    </section>
  
</body></html>